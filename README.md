# GeneXus Exposure Notifications

This module enables GeneXus applications to easily access the [Exposure Notification](https://en.wikipedia.org/wiki/Exposure_Notification) API developed by Apple Inc. and Google. It provides interaction with the API through an unified and cross-platform layer, which takes care of the native binding specifics for either iOS or Android devices.

## Introduction

In April 2020 [Apple and Google announced](https://www.apple.com/newsroom/2020/04/apple-and-google-partner-on-covid-19-contact-tracing-technology/) a joint effort to develop what was later released as the Exposure Notification system implemented for their respective phone platforms (iOS and Android). This technology enables smartphones to determine -and report to its owner- whether a person may have recently been near someone that had been infected with COVID-19.

The protocol uses a combination of privacy-preserving cryptography and Bluetooth Low Energy technology and is designed to be offered as an opt-in feature within COVID-19 apps developed by approved public health authorities.

This Exposure Notifications module offers a simple way for GeneXus developers to include the technology in their apps, including a common programming interface, along with the libraries that implement the interaction with the operating system level API, for both [iOS](https://developer.apple.com/documentation/exposurenotification) and [Android](https://www.google.com/covid19/exposurenotifications/pdfs/Android-Exposure-Notification-API-documentation-v1.3.2.pdf) implementations. 

## API Features

- Authorize Exposure Notification
- Enable / Disable the Exposure Notification protocol.
- Check whether the Exposure Notification protocol is currently enabled.
- Share diagnosis keys with the server.
- Check for exposure.
- Reset all the data stored in the device by the API.

## Usage

### Step 1 - Add Libraries to GeneXus
Copy the content of the [Libraries](./Libraries) folder to the corresponding Libraries folder under your GeneXus installation as follows:
1. Create a folder named `ExposureAlerts` in the Libraries folder under your GeneXus installation (eg: C:\Program Files (x86)\GeneXus\GeneXus16\Libraries)
2. Copy the content of the [Libraries](./Libraries) folder in this repository to the `ExposureAlerts` folder in your GeneXus installation.

**Note**: Both [Libraries/Android](./Libraries/Android) and [Libraries/iOS](./Libraries/iOS) include their full source code, which is covered by the [Apache License 2.0](./LICENSE) for this repository.

### Step 2 - Add ExposureAlerts module to GeneXus KB
Import the [ExposureAlerts.xml](./GeneXusAPIDefinition/ExposureAlerts.xml) in your GeneXus Knowledgebase. This will add a ExposureAlerts module that includes all the GeneXus objects you need to interact with the API.

## GeneXus Exposure Notifications Objects

### ExposureNotification (GeneXus External Object)

**Note**: All properties and methods in this External Object are Static.

#### Properties

| Name                                                                     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `IsAvailable: Boolean (ReadOnly)`                                        | Returns whether the device supports the use of the ExposureNotification API. It may return `false`, for example, if the API is not available for the OS version currently installed in the device, or if its parental control configuration restrits its use. If the API is available the user may be asked for permission to use it. <br />When this property returns `false`, `AuthorizationStatus` returns `Restricted`, and other properties fallback to do nothing and return `success = false`. |
| `Enabled: Boolean (ReadOnly)`                                            | Returns whether the Exposure Notification service is currently enabled for this device.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                        |
| `AuthorizationStatus: APIAuthorizationStatus (ReadOnly)`                 | Gives more detailed data than `Enabled` property to know whether the user has granted permission, they never have been asked, or the device has restrictions that prevent it from using de API (such as parental controls).<br />The type of this property re-uses the domain defined by GX: `APIAuthorizationStatus`, but in this case, `AuthorizedWhenInUse` won't be returned and should not be considered by the caller.                                                                                                                                                                                                                                                        |                                                                                                                                                                        |
| `BluetoothEnabled: Boolean (ReadOnly)`                                   | Returns whether bluetooth is enabled when the exposure notification service is enabled. This means the return value is only valid if `Enabled = true`, otherwise this property should be ignored (its value is undefined).                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                        | 
| `LastExposureDetectionResult: ExposureDetectionSessionResult (ReadOnly)` | Returns information about the last successful exposure detection session (either if matches were found or not). Each time the services successfully finishes an exposure detection session (processing in the background, looking for matches with diagnosis keys downloaded from the server), the value of this property is updated. If matches were found, it also fires the event `OnExposureDetected`. This result is persisted internally by the API until the user uninstalls the app or calls `ResetLastExposureDetectionResult()`.<br/>Note: calling `Stop` won’t clear the value of this property.                                                                                       |                                                                                                                                                                        |
| `ExposureDetected: Bool (ReadOnly)`                                      | Returns `true` if `LastExposureDetectionResult` has matches (`MatchedKeyCount > 0`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                        |
| `ExposureDetectionMinInterval: Numeric (Read-write)`                     | Minimum time interval (in minutes) between background exposure detection sessions, since the last successful session. Default Value 1440 (24hs). <br/>**Usage Note:** this property allows throttling execution frequency by way of a server-side parameter.                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                        |
| `ExposureInformationUserExplanation: Varchar (Read-write)`               | On each exposure detection session (when matches are found), the OS will inform the user that their exposure details have been revealed to the app. On iOS, this user explanation string will be displayed as part of the UI to inform the user that the exposure API is in use. If this property is empty, both platforms won’t request detailed exposure information (just summary). This could be offered as an option the user can tune as a privacy setting. This means `ExposureDetectionSessionResult.ExposuresInformation` will be empty for the session that was performed when this property was empty.                                                                 |                                                                                                                                                                        |

#### Methods

| Name                                                                           | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Start(ExposureConfiguration): Boolean`                                        | Starts exposure notification services, requesting user permission if needed. Returns `true` if successfully started or was already started (returns the same as calling `Enabled` property). If the services are already started, this method only updates the configuration for upcoming background exposure detection sessions.<br />On **Android** this method does not have an implementation in offline code.                                                                                                                                                                                                                                                                                                                                                                       |
| `Stop(): Boolean`                                                              | Stops the exposure notification services, returning `false` if there was an error. If it was already stopped, it does nothing and returns `true`.<br />Note: this only stops Bluetooth key exchange and detection sessions but does not clear already detected exposure data from the device.<br />On **Android** this method does not have an implementation in offline code.                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `GetTemporaryExposureKeyHistoryForSharing(): Collection<TemporaryExposureKey>` | Should be called when the device owner has been diagnosed positive and wants to share the diagnosis keys. Note this method asks the user for consent on each call. In case of error in a client-side event, it cancels the event execution and shows the error description to the user (unless it was a “user cancelled error”). In case of error in offline events, returns an empty collection.<br />On **Android** this method does not have an implementation for offline code.                                                                                                                                                                                                                                                                                  |
| `GetLastExposureDetectionSessionDetails(): Collection<ExposureInfo>`           | Returns details of the matches detected in the last exposure detection session, that is, the details for current `LastExposureDetectionResult` property. Returns an empty collection if `LastExposureDetectionResult.MatchedKeyCount = 0`. On iOS, an empty collection could be returned even if `MatchedKeyCount > 0` if `ExposureInformationUserExplanation` was empty when the session was performed. <br/> **Implementation Details** <br/> On **Android** `calls Task​<​List​<​ExposureInformation​>>​ getExposureInformation​(​String​ token​);` on each call, alerting the user on each call. <br/> On **iOS** this collection is stored as part of the exposure detection, and might be empty if `ExposureInformationUserExplanation` was empty when the session was performed. |
| `ResetLastExposureDetectionResult(): Boolean`                                  | Deletes the value returned by the property `LastExposureDetectionResult` and `ExposureDetected`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `ShowBluetoothSettings():`                                                     | Shows the device's bluetooth settings to enable it again, if `BluetoothEnabled` is `false`.<br />This method is only available on **Android**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

#### Events

| Name                 | Description                                                                                                                                                                                                                                                                                                                      |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `OnExposureDetected` | This event is fired when the service is enabled and it detects the device has been close to a device whose owner was diagnosed positive and opted in to share the keys. It is fired after a background exposure detection session updates the value of `ResetLastExposureDetectionResult` property (with `MatchedKeyCount > 0`). |

### ExposureConfiguration (Structured Data Type)

| Item                        | Type                       | Description                                                                                                                                                                |
| --------------------------- | -------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| MinimumRiskScore            | RiskScore                  | Minimum risk score. Excludes exposure incidents with scores lower than this. On iOS this value is limited to 255 (UInt8 Max).                                              |
| AttenuationScores           | Collection<RiskScoreLevel> | Scores for attenuation buckets. Must contain 8 scores, one for each bucket: > 73, > 63 & <= 73, > 51 & <= 63, > 33 & <= 51, > 27 & <= 33, > 15 & <=27, > 10 & <= 15, <= 10 |
| AttenuationWeight           | RiskWeight                 | This value is not currently used.                                                                                                                                          |
| DaysSinceLastExposureScores | Collection<RiskScoreLevel> | Scores for days since last exposure buckets. Must contain 8 scores, one for each bucket: >= 14, >= 12, >= 10, >= 8, >= 6, >= 4, >= 2, >= 0                                 |
| DaysSinceLastExposureWeight | RiskWeight                 | This value is not currently used.                                                                                                                                          |
| DurationScores              | Collection<RiskScoreLevel> | Scores for duration buckets. Must contain 8 scores, one for each bucket: = 0, <= 5, <= 10, <= 15, <= 20, <=25, <= 30, > 30                                                 |
| DurationWeight              | RiskWeight                 | This value is not currently used.                                                                                                                                          |
| TransmissionRiskScores      | Collection<RiskScoreLevel> | Scores for transmission risk buckets. Must contain 8 scores.                                                                                                               |
| TransmissionRiskWeight      | RiskWeight                 | This value is not currently used.                                                                                                                                          |

### TemporaryExposureKey (Structured Data Type)

| Item                       | Type           | Description                                                                           |
| -------------------------- | -------------- | ------------------------------------------------------------------------------------- |
| KeyData                    | LongVarChar    | The randomly generated Temporary Exposure Key information in base 64 format.          |
| RollingStartIntervalNumber | IntervalNumber | A number describing when a key starts.                                                |
| RollingPeriod              | IntervalNumber | Duration this key is valid. It's the number of 10-minute windows between key rolling. |
| TransmissionRiskLevel      | RiskLevel      | Risk of transmission associated with the person this key came from.                   |

### ExposureDetectionSessionResult (Structured Data Type)

| Item                 | Type                             | Description                                                                                                                                                                                                                                                                                                                                      |
| -------------------- | -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Id                   | ExposureDetectionSessionResultId |                                                                                                                                                                                                                                                                                                                                                  |
| SessionTimeStamp     | DateTime                         | DateTime the session was performed.                                                                                                                                                                                                                                                                                                              |
| LastExposureDate     | Date                             | Date of the last exposure detected in this session. Empty if `MatchedKeyCount = 0`                                                                                                                                                                                                                                                               |
| MatchedKeyCount      | Numeric                          | Number of diagnosis keys that matched.                                                                                                                                                                                                                                                                                                           |
| MaximumRiskScore     | RiskScore                        | 0 if `MatchedKeyCount = 0`                                                                                                                                                                                                                                                                                                                       |
| AttenuationDurations | Collection<Numeric>              | Durations in seconds at certain radio signal attenuations. <ul><li>First item = Sum of durations for all exposures when attenuation was <= 50. <li>Second Item = Sum of durations for all exposures when attenuation was > 50. These durations are aggregated across all exposures and capped at 30 minutes. </ul>Empty if `MatchedKeyCount = 0` |

### ExposureInfo (Structured Data Type)

| Item                  | Type                | Description                                                                                                                                                                                                                         |
| --------------------- | ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Date                  | Date                | Date the exposure occurred.                                                                                                                                                                                                         |
| Duration              | Numeric             | Length of exposure in minutes.                                                                                                                                                                                                      |
| TransmissionRiskLevel | RiskLevel           | The transmission risk associated with the matched diagnosis key.                                                                                                                                                                    |
| TotalRiskScore        | RiskScore           |                                                                                                                                                                                                                                     |
| AttenuationValue      | Numeric(3,0)        | Attenuation value of the peer device when exposure occurred.                                                                                                                                                                        |
| AttenuationDurations  | Collection<Numeric> | Durations in seconds at certain radio signal attenuations. <ul><li>First item = Sum of durations for all exposures when attenuation was <= 50. <li>Second Item = Sum of durations for all exposures when attenuation was > 50.</ul> |

### DiagnosisKeyDataProviderResult (Structured Data Type)

| Item | Type            | Description |
| ---- | --------------- | ----------- |
| Keys | Collection<URL> |             |

### Domains

| Name                                               | Description                                                                                                                                                                                                                                            |
| -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `RiskLevel: Numeric (1,0) Enum`                    | <ul><li>Invalid = 0<li>Lowest = 1<li>Low = 2<li>LowMedium = 3<li> Medium = 4<li> MediumHigh = 5 <li> High = 6 <li> VeryHigh = 7 <li> Highest = 8 </ul>                                                                                                 |
| `RiskScoreLevel: Numeric (1,0)`                    | Value Range: 0:8                                                                                                                                                                                                                                       |
| `RiskScore: Numeric (4,0)`                         | Value Range: 0:4096                                                                                                                                                                                                                                    |
| `RiskWeight: Numeric (3,0)`                        | Value Range: 0:100                                                                                                                                                                                                                                     |
| `IntervalNumber: Numeric (10,0)`                   | A number for each 10 minute window that is shared between all devices participating in the protocol. These time windows are based Unix Time (epoch 1970-01-01 00:00:00). It's calculated as: ENIN = <Seconds since 1970-01-01 00:00:00> / ( 60 \* 10 ) |
| `DiagnosisKeyId**: Numeric (10,0)`                 | Used for diagnosis keys download pagination (more explanation below).                                                                                                                                                                                  |
| `ExposureDetectionSessionResultId: Varchar (100).` | Opaque string that identifies the session result.                                                                                                                                                                                                      |                                                                                               

## Diagnosis Keys Downloading and Uploading

### Downloading

The service, as part of the background exposure detection sessions, needs to download diagnosis keys from the server. For this, a Data Provider must be set in the `Exposure Notification Diagnosis Keys Provider` property for the main object (metadata key `@ExposureAlerts_ExposureNotificationDiagnosisKeysProvider`).

That data provider output must be of `DiagnosisKeyDataProviderResult` type. This SDT contains a collection of URLs from which the device may download the diagnosis key files stored by the server.

### Uploading

The diagnosis keys to upload are those obtained from the `GetTemporaryExposureKeyHistoryForSharing()` method. It's important to note that the procedure that uploads these keys must require authentication and check that the keys come from a device already verified as belonging to that user.

## Usage Example

On app launch (or shortly after), the app may check if `ExposureNotification.AuthorizationStatus = NotDetermined` and in that case encourage the user to authorize the use of the exposure notifications feature, explaining its benefits and privacy safeguards. After getting user consent it may call `ExposureNotification.Start()`.

When users are diagnosed positive, the app should encourage them to share the diagnosis keys, as a way to help other potentially exposed people to get an alert. The app may get these keys calling `ExposureNotification.GetTemporaryExposureKeyHistoryForSharing()` and upload the results to the server.

The main app object may subscribe to the `ExposureNotification.OnExposureDetected` event, and alert users that they were exposed to a positive diagnosed person. Exposure can be periodically checked using `ExposureNotification.ExposureDetected` (or `ExposureNotification.LastExposureDetectionResult`), and if `true`, inform the users when and for how long the potential exposures occurred. `ExposureNotification.GetLastExposureDetectionSessionDetails()` may be used to show further details about detected exposures.

## License

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
